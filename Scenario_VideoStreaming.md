- [Video streaming service](#video-streaming-service)
  - [Basic concepts](#basic-concepts)
    - [Protocols, Codecs and containers](#protocols-codecs-and-containers)
    - [Adaptive bitrate segmentation](#adaptive-bitrate-segmentation)
  - [High level architecture](#high-level-architecture)
    - [Video uploading flow](#video-uploading-flow)
    - [Video streaming flow](#video-streaming-flow)
  - [Detailed component design](#detailed-component-design)
    - [Flowchart](#flowchart)
    - [Video transcoding](#video-transcoding)
      - [Motivation](#motivation)
      - [Encoding format](#encoding-format)
      - [Flowchart](#flowchart-1)
        - [Preprocessing](#preprocessing)
        - [DAG scheduler](#dag-scheduler)
        - [Resource manager](#resource-manager)
        - [Temporary storage](#temporary-storage)
    - [Storage](#storage)
  - [Optimization](#optimization)
    - [Parallel upload](#parallel-upload)
    - [Cost saving](#cost-saving)
      - [CDN cost](#cdn-cost)
  - [Real world practices](#real-world-practices)

# Video streaming service
## Basic concepts
### Protocols, Codecs and containers
  * Container: Represented by video file extension. It includes video stream, audio stream and metadata (bitrate, device, resolution, time of creation, subtitles, etc.)  
    * FLV: Flash video format created by Adobe.
    * MP4: Standard MPEG-4 format.
    * WMV: Windows media video.
    * MOV: Apple quicktime
  * Codecs: 
    * Video codecs: 
      * H.264 - the most commonly used video format
      * H.265(HEVC) - double compression rate of H.264, however need triple resources to encode, proprietary protocol. 
      * VP9
      * Av1 
    * Audio codecs:
      * MP3 - Popular with wide support. Save space without noticeable quality loss. Limited functionality. 
      * AAC - Widely supported. More efficient than MP3. Limit on audio channel.
      * AC3 
  * Protocols: A standardized set of rules for storing containers, codecs, metadata, and folder structure. 
    * TCP/IP based
      * RTP: RTSP and RTCP
      * RTMP: Real time messaging protocol
    * HTTP based
      * MPEG4 (MPEG-4 Part10/12/14 )
      * HLS (Http Live stream)
        * .m3u8
      * MPEG-DASH (Dynamic adaptive streaming over HTTP)
  * References:
    * [video1](https://www.youtube.com/watch?v=XvoW-bwIeyY&ab_channel=Qencode)
    * [video2](https://www.youtube.com/watch?v=ek1xWmgZlTM&ab_channel=livestreamninja)

![](./images/youtube_video_format_codecs.png)

### Adaptive bitrate segmentation
* Video could be encoded into different resolution frames. In terms of which frames to play, it could be decided based on the network speed. 

![](./images/youtube_videoformats_bitrate_context.png)

![](./images/youtube_videoformats_bitrate_segmentation.png)
 

## High level architecture

![High level arch](./images/youtube_highlevel_overview.png)

### Video uploading flow
* Upload video

![Upload video](./images/youtube_video_upload.png)

* Upload metadata

![Upload metadata](./images/youtube_video_upload_metadata.png)

### Video streaming flow

## Detailed component design
* [Distributed processing at FB scale](https://www.cs.princeton.edu/~wlloyd/papers/sve-sosp17.pdf)

![](./images/youtube_video_streaming.png)

### Flowchart
* Inspection: Make sure videos have good quality and not malformed.
* Video transcoding: Videos are converted to support different container/codec. 
* Thumbnail: Can be manually uploaded by the user or automatically generated by the system.
* Watermark: An image overlay on top of your video contains identifying information about your video. 

![Video processing](./images/youtube_video_videoProcessingAtFBScale.png)

### Video transcoding
#### Motivation
* Raw video consumes large amount of storage space. 
* Many browsers and devices only support certain form of encoding.
* To deliver good user experience, it is feasible to deliver high resolution video to users who have high network bandwidth and low resolution video to users who have low network bandwidth. 

#### Encoding format
* Most encoding consists of two components:
  * Container: .avi, .mp4, etc. A basket that contains the video file, metadata, etc.
  * Codecs: Compression and decompression algorithm. 

#### Flowchart 

![video transcoding architecture](./images/youtube_video_transcoding.png)

##### Preprocessing
  1. Video splitting: Video stream is split into smaller groups of segments.
  2. DAG generation: Generates DAG based on configuration files client programs write.

##### DAG scheduler
* A sample DAG scheduler

![DAG scheduler](./images/youtube_video_dagScheduler.png)

##### Resource manager
* Contains three queues and a task scheduler
  * Task queue: PQ contains tasks
  * Worker queue: Worker utilization info
  * Running queue: Currently running tasks
  * Task scheduler: Which worker to execute the task
* Process:
  1. The task scheduler gets the highest priority task from the task queue.
  2. The task scheduler gets the optimal task worker to run the task from the worker queue. 
  3. The task scheduler instructs the chosen task worker to run the task.
  4. The task scheduler binds the task/worker info and puts it in the running queue.
  5. The task scheduler removes the job from the running queue once the job is done.

![resource manager](./images/youtube_video_resourcemanager.png)

##### Temporary storage
* Multiple storage options are used including blob storage, memory, etc.

### Storage
* How does Youtube serve high quality videos with low latency: https://www.8bitmen.com/youtube-architecture-how-does-it-serve-high-quality-videos-with-low-latency/
* How does Youtube store so many videos: https://www.8bitmen.com/youtube-database-how-does-it-store-so-many-videos-without-running-out-of-storage-space/

## Optimization
### Parallel upload
* Introduce message queue between component to make the process asynchronous. 
  * The encoding module does not need to wait for the download module. 
  * The upload module does not need to wait for encoding module. 

![Serial upload](./images/youtube_video_optimization_serialUpload.png)

![Parallel upload](./images/youtube_video_optimization_parallelUpload.png)

### Cost saving
#### CDN cost
* CDN is expensive, especially when the data size is large. 
  * Using Amazon CDN as example https://aws.amazon.com/cloudfront/pricing/
  * Assume 100% of traffic is served from the United States. The average cost per GB is $0.02. For simplicity, we only calculate the cost of video streaming.
â€¢ 5 million * 5 videos * 0.3GB * $0.02 = $150,000 per day.

![Amazon CDN price](./images/youtube_video_optimization_cdn.png)

* How to reduce the CDN cost
  * Only serve the most popular contents from CDN and other videos from webserver
  * Some videos are popular only in certain regions. There is no need to distribute these videos to other regions.
  * Build your own CDN like Netflix and partner with Internet Service Providers ( Comcast, AT&T, Verizon, etc.). Building your CDN is a giant project; however, this could make sense for large streaming companies. 

## Real world practices
* [Netflix Open Connect]()
* Proactive CDN caching at Facebook: https://www.youtube.com/watch?v=CbbeSg1t224&ab_channel=JustinMiller
* Building and scaling a performant CDN: https://www.youtube.com/watch?v=TLbzvbfWmfY&ab_channel=Fastly
* Fastly: https://www.youtube.com/watch?v=farO15_0NUQ&ab_channel=GOTOConferences

![](./images/video_streaming_cdn_benefits.png)