- [Youtube](#youtube)
  - [CDN cost](#cdn-cost)
  - [High level architecture](#high-level-architecture)
    - [Video uploading flow](#video-uploading-flow)
    - [Video streaming flow](#video-streaming-flow)
      - [Streaming protocols](#streaming-protocols)
  - [Detailed component design](#detailed-component-design)
    - [Flowchart](#flowchart)
    - [Video transcoding](#video-transcoding)
      - [Motivation](#motivation)
      - [Encoding format](#encoding-format)
      - [Flowchart](#flowchart-1)
        - [Preprocessing](#preprocessing)
        - [DAG scheduler](#dag-scheduler)
        - [Resource manager](#resource-manager)
        - [Temporary storage](#temporary-storage)
    - [Storage](#storage)
  - [Optimization](#optimization)
    - [Parallel upload](#parallel-upload)
    - [Cost saving](#cost-saving)
      - [CDN cost](#cdn-cost-1)

# Youtube
## CDN cost

## High level architecture

![High level arch](./images/youtube_highlevel_overview.png)

### Video uploading flow
* Upload video

![Upload video](./images/youtube_video_upload.png)

* Upload metadata

![Upload metadata](./images/youtube_video_upload_metadata.png)

### Video streaming flow
#### Streaming protocols
* MPEG
* Apple HLS
* Microsoft Smooth Streaming
* Adobe HTTP Dynamic Streaming

![High level arch](./images/youtube_video_streaming.png)

## Detailed component design
* [Distributed processing at FB scale](https://www.cs.princeton.edu/~wlloyd/papers/sve-sosp17.pdf)

### Flowchart
* Inspection: Make sure videos have good quality and not malformed.
* Video transcoding: Videos are converted to support different container/codec. 
* Thumbnail: Can be manually uploaded by the user or automatically generated by the system.
* Watermark: An image overlay on top of your video contains identifying information about your video. 

![Video processing](./images/youtube_video_videoProcessingAtFBScale.png)

### Video transcoding
#### Motivation
* Raw video consumes large amount of storage space. 
* Many browsers and devices only support certain form of encoding.
* To deliver good user experience, it is feasible to deliver high resolution video to users who have high network bandwidth and low resolution video to users who have low network bandwidth. 

#### Encoding format
* Most encoding consists of two components:
  * Container: .avi, .mp4, etc. A basket that contains the video file, metadata, etc.
  * Codecs: Compression and decompression algorithm. 

#### Flowchart 

![video transcoding architecture](./images/youtube_video_transcoding.png)

##### Preprocessing
  1. Video splitting: Video stream is split into smaller groups of segments.
  2. DAG generation: Generates DAG based on configuration files client programs write.

##### DAG scheduler
* A sample DAG scheduler

![DAG scheduler](./images/youtube_video_dagScheduler.png)

##### Resource manager
* Contains three queues and a task scheduler
  * Task queue: PQ contains tasks
  * Worker queue: Worker utilization info
  * Running queue: Currently running tasks
  * Task scheduler: Which worker to execute the task
* Process:
  1. The task scheduler gets the highest priority task from the task queue.
  2. The task scheduler gets the optimal task worker to run the task from the worker queue. 
  3. The task scheduler instructs the chosen task worker to run the task.
  4. The task scheduler binds the task/worker info and puts it in the running queue.
  5. The task scheduler removes the job from the running queue once the job is done.

![resource manager](./images/youtube_video_resourcemanager.png)

##### Temporary storage
* Multiple storage options are used including blob storage, memory, etc.

### Storage
* How does Youtube serve high quality videos with low latency: https://www.8bitmen.com/youtube-architecture-how-does-it-serve-high-quality-videos-with-low-latency/
* How does Youtube store so many videos: https://www.8bitmen.com/youtube-database-how-does-it-store-so-many-videos-without-running-out-of-storage-space/

## Optimization
### Parallel upload
* Introduce message queue between component to make the process asynchronous. 
  * The encoding module does not need to wait for the download module. 
  * The upload module does not need to wait for encoding module. 

![Serial upload](./images/youtube_video_optimization_serialUpload.png)

![Parallel upload](./images/youtube_video_optimization_parallelUpload.png)

### Cost saving
#### CDN cost
* CDN is expensive, especially when the data size is large. 
  * Using Amazon CDN as example https://aws.amazon.com/cloudfront/pricing/
  * Assume 100% of traffic is served from the United States. The average cost per GB is $0.02. For simplicity, we only calculate the cost of video streaming.
â€¢ 5 million * 5 videos * 0.3GB * $0.02 = $150,000 per day.

![Amazon CDN price](./images/youtube_video_optimization_cdn.png)

* How to reduce the CDN cost
  * Only serve the most popular contents from CDN and other videos from webserver
  * Some videos are popular only in certain regions. There is no need to distribute these videos to other regions.
  * Build your own CDN like Netflix and partner with Internet Service Providers ( Comcast, AT&T, Verizon, etc.). Building your CDN is a giant project; however, this could make sense for large streaming companies. 